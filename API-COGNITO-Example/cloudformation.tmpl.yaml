AWSTemplateFormatVersion: 2010-09-09

Resources:
    Function:
        Type: AWS::Lambda::Function
        Properties:
            Runtime: python2.7
            Handler: lambda.handler
            Role: {{ .LambdaRole }}
            Code: lambda.zip

    PermissionApiGateway:
        Type: AWS::Lambda::Permission
        DependsOn: Function
        Properties:
            Action: lambda:InvokeFunction
            FunctionName: !GetAtt Function.Arn
            Principal: apigateway.amazonaws.com

    PermissionCognito:
        Type: AWS::Lambda::Permission
        DependsOn: [Function, UserPool]
        Properties:
            Action: lambda:InvokeFunction
            FunctionName: !GetAtt Function.Arn
            Principal: cognito-idp.amazonaws.com
            SourceArn: !GetAtt UserPool.Arn

    Api:
        Type: AWS::ApiGateway::RestApi
        DependsOn: Function
        Properties:
            Body:
                swagger: '2.0'
                info:
                    title: {{ .ApiTitle }}
                    version: latest
                securityDefinitions:
                    {{ .UserPoolName }}:
                        type: apiKey
                        name: Authorization
                        in: header
                        x-amazon-apigateway-authtype: cognito_user_pools
                        x-amazon-apigateway-authorizer:
                            providerARNs:
                                - !GetAtt UserPool.Arn
                            type: cognito_user_pools
                paths:
                    /:
                        x-amazon-apigateway-any-method:
                            security: [{{ .UserPoolName }}: []]
                            x-amazon-apigateway-integration:
                                type: aws_proxy
                                httpMethod: POST
                                uri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Function.Arn}/invocations'

    Deployment:
        Type: AWS::ApiGateway::Deployment
        DependsOn: Api
        Properties:
            RestApiId: !Ref Api
            StageName: {{ .StageName }}

    UserPool:
        Type: Custom::COGNITO-UserPool
        DependsOn: Function
        Properties:
            ServiceToken: {{ .ServiceTokenUserPool }}
            Properties:
                PoolName: {{ .UserPoolName }}
                Policies:
                    PasswordPolicy:
                        MinimumLength: 10
                        RequireLowercase: false
                        RequireNumbers: false
                        RequireSymbols: false
                        RequireUppercase: false
                AutoVerifiedAttributes: [email]
                AliasAttributes: [email]
                MfaConfiguration: 'OFF'
                UserPoolTags:
                    TagName: TagValue
                AdminCreateUserConfig:
                    AllowAdminCreateUserOnly: false
                    UnusedAccountValidityDays: 7
                Schema:
                    - Name: email
                      AttributeDataType: String
                      DeveloperOnlyAttribute: false
                      Mutable: true
                      Required: true
                      StringAttributeConstraints:
                          MinLength: 5
                          MaxLength: 2048
                LambdaConfig:
                    PostConfirmation: !GetAtt Function.Arn

    UserPoolClient:
        Type: Custom::COGNITO-UserPoolClient
        DependsOn: UserPool
        Properties:
            ServiceToken: {{ .ServiceTokenUserPoolClient }}
            Properties:
                UserPoolId: !Ref UserPool
                ClientName: Client
                GenerateSecret: false
                RefreshTokenValidity: 7
                ReadAttributes:
                    - email
                    - email_verified

Outputs:
    UserPoolId:
        Value: !Ref UserPool
    UserPoolClientId:
        Value: !Ref UserPoolClient
    ApiUrl:
        Value: !Sub 'https://${Api}.execute-api.${AWS::Region}.amazonaws.com/{{ .StageName }}'
