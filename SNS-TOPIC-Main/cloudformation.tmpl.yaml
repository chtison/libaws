AWSTemplateFormatVersion: "2010-09-09"
Resources:
    Topic:
        Type: AWS::SNS::Topic

{{- range $i, $e := .EndpointsSMS }}

    SubscriptionSms{{ $i }}:
        Type: AWS::SNS::Subscription
        Properties:
            Protocol: sms
            Endpoint: '{{ . }}'
            TopicArn: !Ref Topic
{{- end }}

{{- range $i, $e := .EndpointsEmail }}

    SubscriptionEmail{{ $i }}:
        Type: AWS::SNS::Subscription
        Properties:
            Protocol: email
            Endpoint: '{{ . }}'
            TopicArn: !Ref Topic
{{- end }}

    Policy:
        Type: AWS::IAM::ManagedPolicy
        Properties:
            PolicyDocument:
                Version: 2012-10-17
                Statement:
                    - Effect: Allow
                      Action: sns:Publish
                      Resource: !Ref Topic

    LambdaRole:
        Type: AWS::IAM::Role
        Properties:
            AssumeRolePolicyDocument:
                Version: 2012-10-17
                Statement:
                    Effect: Allow
                    Principal:
                        Service: lambda.amazonaws.com
                    Action: sts:AssumeRole
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
                - !Ref Policy

Outputs:
    TopicARN:
        Value: !Ref Topic
        Export:
            Name: SNS-TOPIC-Main
    PolicyARN:
        Value: !Ref Policy
        Export:
            Name: SNS-TOPIC-Main-POLICY
    LambdaRoleARN:
        Value: !GetAtt LambdaRole.Arn
        Export:
            Name: SNS-TOPIC-Main-ROLE-LAMBDA
